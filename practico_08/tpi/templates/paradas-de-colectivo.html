{% set active_page = "paradas-de-colectivo" %}
{% extends "base.html" %}

{% block header %}
  <h1>{% block title %}Paradas de colectivo{% endblock %}</h1>
{% endblock %}

{% block precontent %}
    <h2 class="text-center text-5xl text-teal-500">Paradas de colectivo - Cuando llegó</h2>
    <!--<h2 class="text-center text-2xl text-teal-500">Informes por lineas de colectivo</h2>-->
{% endblock %}

{% block content %}
<div class="flex flex-wrap -mx-3 mb-2">
    <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0">
        <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="sLineas">
            Linea de colectivo
        </label>
        <div class="relative">
            <select class="search_result absolute bg-gray-200 border border-gray-200 text-gray-700 inset-y-30 right-0 left-0 py-3 px-4 rounded" id="sLineas">
                <option selected disabled>Seleccionar linea de colectivo</option>
            </select>
        </div>
    </div>

    <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0">
        <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="calle">
            Calle
        </label>
        <div class="relative">
            <select class="search_result absolute bg-gray-200 border border-gray-200 text-gray-700 inset-y-30 right-0 left-0 py-3 px-4 rounded" id="calle">
                <option selected disabled>Seleccionar linea primero</option>
            </select>
        </div>
    </div>

    <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0">
        <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="calleInterseccion">
            Calle intersección
        </label>
        <div class="relative">
            <select class="search_result absolute bg-gray-200 border border-gray-200 text-gray-700 inset-y-30 right-0 left-0 py-3 px-4 rounded" id="calleInterseccion">
                <option selected disabled>Seleccionar parada primero</option>
            </select>
        </div>
    </div>

    <div class="w-full md:w-1/4 px-3 mb-6 md:mb-0">
        <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="paradaInput">
            Parada
        </label>
        <input value="" name="parada" type="number" class="block appearance-none w-full bg-gray-200 border border-gray-200 text-gray-700 py-3 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500" id="paradaInput" />
    </div>
</div>

<h3 class="text-4xl text-black-500 mb-5">Introducción</h3>
<canvas id="myChart" width="400" height="400"></canvas>

<h3 class="text-4xl text-black-500 mb-5">Información</h3>
<p class="mb-4">Parte de la información para el desarrollo del sistema es obtenida desde el sitio web del sistema "¿Cuándo llega?" dela Municipalidad de Rosario. A partir del mismo se pueden identificar todas las líneas de colectivo que se encuentranactivas en la ciudad, junto con sus recorridos, paradas identificadas por intersecciones de calles y horarios que debencumplir las unidades.</p>
<p class="mb-4">Toda esta información es recopilada desde el código HTML que se inspecciona cuando se visita el sitio del ETR(Ente de la Movilidad de Rosario). Se monitorizan las peticiones HTTP que realiza el mismo al interactuar con losselectores del formulario y se comprende la estructura de la información disponible públicamente. Esta se almacenarála base de datos del sistema, previamente diseñada con tablas relacionadas que harán posible las diferentes consultaspara generar reportes que se detallarás más adelante.</p>
<p class="mb-4">Para completar la información necesaria para cumplir con los objetivos del sistema a desarrollar, es necesario conocerla cantidad de pasajeros que ascienden en cada parada a cada unidad, y en qué momento. Esto nos permitirá estimar ladensidad de personas en los colectivos, y a partir de allí continuar con el análisis establecido por el trabajo. Dichosdatos pueden ser obtenidos mediante una fuente interna de la municipalidad, ya que han sido medidos en el pasado paradeterminadas unidades la cantidad de boletos que se marcan a lo largo del recorrido. En caso de no contar con estafuente, se procederá a simular los datos.</p>

<h3 class="text-4xl text-black-500 mb-5">Reportes</h3>
<p class="mb-4">Se confeccionarán reportes en forma de gráficos con el objetivo de visualizar diferentes características sobre elfuncionamiento del sistema de transporte, y a partir de allí analizar posibles medidas para la optimización del servicio.Se le permitirá al usuario ingresar los parámetros mediante los cuales se crearán las consultas a la base de datos medianteGraphQL, tales como el área geográfica para conocer la densidad de pasajeros por barrio, franja horaria, días de lasemana, líneas de colectivo, etc. Los mismos podrán ser utilizados para auditar el servicio, destacar qué zonas de laciudad tienen mayor flujo de pasajeros, detectar cuándo la demanda excede la oferta, estimar el horario en el que pasaun colectivo por una parada sin servicio de GPS, entre otros.</p>
{% endblock %}

{% block scripts %}
<script>
'use strict';

window.chartColors = {
	red: 'rgb(255, 99, 132)',
	orange: 'rgb(255, 159, 64)',
	yellow: 'rgb(255, 205, 86)',
	green: 'rgb(75, 192, 192)',
	blue: 'rgb(54, 162, 235)',
	purple: 'rgb(153, 102, 255)',
	grey: 'rgb(201, 203, 207)'
};

(function(global) {
	var MONTHS = [
		'January',
		'February',
		'March',
		'April',
		'May',
		'June',
		'July',
		'August',
		'September',
		'October',
		'November',
		'December'
	];

	var COLORS = [
		'#4dc9f6',
		'#f67019',
		'#f53794',
		'#537bc4',
		'#acc236',
		'#166a8f',
		'#00a950',
		'#58595b',
		'#8549ba'
	];

	var Samples = global.Samples || (global.Samples = {});
	var Color = global.Color;

	Samples.utils = {
		// Adapted from http://indiegamr.com/generate-repeatable-random-numbers-in-js/
		srand: function(seed) {
			this._seed = seed;
		},

		rand: function(min, max) {
			var seed = this._seed;
			min = min === undefined ? 0 : min;
			max = max === undefined ? 1 : max;
			this._seed = (seed * 9301 + 49297) % 233280;
			return min + (this._seed / 233280) * (max - min);
		},

		numbers: function(config) {
			var cfg = config || {};
			var min = cfg.min || 0;
			var max = cfg.max || 1;
			var from = cfg.from || [];
			var count = cfg.count || 8;
			var decimals = cfg.decimals || 8;
			var continuity = cfg.continuity || 1;
			var dfactor = Math.pow(10, decimals) || 0;
			var data = [];
			var i, value;

			for (i = 0; i < count; ++i) {
				value = (from[i] || 0) + this.rand(min, max);
				if (this.rand() <= continuity) {
					data.push(Math.round(dfactor * value) / dfactor);
				} else {
					data.push(null);
				}
			}

			return data;
		},

		labels: function(config) {
			var cfg = config || {};
			var min = cfg.min || 0;
			var max = cfg.max || 100;
			var count = cfg.count || 8;
			var step = (max - min) / count;
			var decimals = cfg.decimals || 8;
			var dfactor = Math.pow(10, decimals) || 0;
			var prefix = cfg.prefix || '';
			var values = [];
			var i;

			for (i = min; i < max; i += step) {
				values.push(prefix + Math.round(dfactor * i) / dfactor);
			}

			return values;
		},

		months: function(config) {
			var cfg = config || {};
			var count = cfg.count || 12;
			var section = cfg.section;
			var values = [];
			var i, value;

			for (i = 0; i < count; ++i) {
				value = MONTHS[Math.ceil(i) % 12];
				values.push(value.substring(0, section));
			}

			return values;
		},

		color: function(index) {
			return COLORS[index % COLORS.length];
		},

		transparentize: function(color, opacity) {
			var alpha = opacity === undefined ? 0.5 : 1 - opacity;
			return Color(color).alpha(alpha).rgbString();
		}
	};

	// DEPRECATED
	window.randomScalingFactor = function() {
		return Math.round(Samples.utils.rand(-100, 100));
	};

	// INITIALIZATION

	Samples.utils.srand(Date.now());


}(this));






var MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
var config = {
    type: 'line',
    data: {
        labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
        datasets: [{
            label: 'My First dataset',
            backgroundColor: window.chartColors.red,
            borderColor: window.chartColors.red,
            data: [
                randomScalingFactor(),
                randomScalingFactor(),
                randomScalingFactor(),
                randomScalingFactor(),
                randomScalingFactor(),
                randomScalingFactor(),
                randomScalingFactor()
            ],
            fill: false,
        }, {
            label: 'My Second dataset',
            fill: false,
            backgroundColor: window.chartColors.blue,
            borderColor: window.chartColors.blue,
            data: [
                randomScalingFactor(),
                randomScalingFactor(),
                randomScalingFactor(),
                randomScalingFactor(),
                randomScalingFactor(),
                randomScalingFactor(),
                randomScalingFactor()
            ],
        }]
    },
    options: {
        responsive: false,
        title: {
            display: true,
            text: 'Chart.js Line Chart'
        },
        tooltips: {
            mode: 'index',
            intersect: false,
        },
        hover: {
            mode: 'nearest',
            intersect: true
        },
        scales: {
            xAxes: [{
                display: true,
                scaleLabel: {
                    display: true,
                    labelString: 'Month'
                }
            }],
            yAxes: [{
                display: true,
                scaleLabel: {
                    display: true,
                    labelString: 'Value'
                }
            }]
        }
    }
};

window.onload = function() {
    var ctx = document.getElementById('myChart').getContext('2d');
    window.myLine = new Chart(ctx, config);
};
</script>
<script type=text/javascript>
$(function() { //Populate paradas
    var graphQ = `{ allLineas{ edges{ node{ id name } } } }`
    $('#query').text(graphQ)
    $.ajax({
        type : 'GET',
        url: $SCRIPT_ROOT + '/graphql',
        data: {
            query: graphQ
        },
        success: function(data){
            data.data.allLineas.edges.forEach(function(p){
                $('#sLineas').append(`<option value="${p.node.id}">${p.node.name}</option>`);
            })
            $('#response').text(JSON.stringify(data.data, null, 2))
        },//success
        error: function(XMLHttpRequest, textStatus, errorThrown) {
            console.log( "Request failed: " + textStatus + " "+ errorThrown );
        }//error
    });//$ajax
});

$(function() {
    var calle_id = ''
    $( "#calle" ).change(function() {
        var id_linea = $('#sLineas').val()
        var graphQ = `query{ calle2ByIdlineaCalle1(idLinea: `+id_linea+`, idCalle1: `+$( this ).val()+`){ calle2 {id nombre} } }`
        $('#query').text(graphQ)
        $.ajax({
            type : 'GET',
            url: $SCRIPT_ROOT + '/graphql',
            data: {
                query: graphQ
            },
            success: function(data){
                $('#calleInterseccion').empty()
                data.data.calle2ByIdlineaCalle1.forEach(c => $('#calleInterseccion').append(`<option value="${c.calle2.id}">${c.calle2.nombre}</option>`));
                $('#response').text(JSON.stringify(data.data, null, 2))
            },//success
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.log( "Request failed: " + textStatus + " "+ errorThrown );
            }//error
        });//$ajax
    });
    function getInterseccion($) { //Buscando intersección luego de click en Calle
        console.log($)
        var graphQ = `query{ interSearch(q: "`+calle_id+`"){ id calle2{ id nombre } } }`
        $('#query').text(graphQ)
        $.ajax({
            type : 'GET',
            url: $SCRIPT_ROOT + '/graphql',
            data: {
                query: graphQ
            },
            success: function(data){
                $('#calleI_search').toggle();
                $('#calleInterseccion').empty()
                data.data.interSearch.forEach(i => $('#calleInterseccion').append(`<option value="${i.calle2.id}">${i.calle2.nombre}</option>`));
                $('#response').text(JSON.stringify(data.data, null, 2))
            },//success
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.log( "Request failed: " + textStatus + " "+ errorThrown );
            }//error
        });//$ajax
    };
    $('#calle_search').bind('click', function() {
        $( "input#calle" ).val($( this ).text())
        $( "input#calle_value" ).val($( this ).text())
        getInterseccion($)
        $( this ).toggle()
    })
    $('#sLineas').change(function() {
        var calle1 = $(this).val()
        var graphQ = `query{ calle1ByIdLinea(idLinea: `+calle1+`){ calle1{id nombre} } }`
        $('#query').text(graphQ)
        $.ajax({
            type : 'GET',
            url: $SCRIPT_ROOT + '/graphql',
            data: {
                query: graphQ
            },
            success: function(data){
                $('#calle').empty()
                data.data.calle1ByIdLinea.forEach(c => $('#calle').append(`<option value="${c.calle1.id}">${c.calle1.nombre}</option>`));
                $('#response').text(JSON.stringify(data.data, null, 2))
            },//success
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.log( "Request failed: " + textStatus + " "+ errorThrown );
            }//error
        });//$ajax
    })
    $('#calleInterseccion').change(function() {
        var linea = $('#sLineas').val()
        var calle1 = $('#calle').val()
        var graphQ = `query{ paradaByIdlineaC1C2(idLinea: `+linea+`, idCalle1: `+calle1+`, idCalle2: `+$( this ).val()+`){ idParada } }`
        $('#query').text(graphQ)
        $.ajax({
            type : 'GET',
            url: $SCRIPT_ROOT + '/graphql',
            data: {
                query: graphQ
            },
            success: function(data){
                console.log(data.data.paradaByIdlineaC1C2)
                if(data.data.paradaByIdlineaC1C2.length > 0)
                    $('#paradaInput').val( data.data.paradaByIdlineaC1C2[0].idParada );
                $('#response').text(JSON.stringify(data.data, null, 2))
            },//success
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.log( "Request failed: " + textStatus + " "+ errorThrown );
            }//error
        });//$ajax
    })
    $('button#lineas').bind('click', function() {
        var graphQ = `query{ lineas{ id name paradas{ edges{ node{ id idCallePpal idCalleCruce } } } } }`
        $('#query').text(graphQ)
        $.ajax({
            type : 'GET',
            url: $SCRIPT_ROOT + '/graphql',
            data: {
                query: graphQ
            },
            success: function(data){
                $('#response').text(JSON.stringify(data.data, null, 2))
            },//success
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.log( "Request failed: " + textStatus + " "+ errorThrown );
            }//error
        });//$ajax
    });
});
</script>
{% endblock %}
